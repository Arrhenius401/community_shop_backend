<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community_shop.backend.mapper.EvaluationMapper">

    <!-- 结果集映射：严格匹配evaluation表字段与Evaluation实体 -->
    <resultMap id="BaseResultMap" type="com.community_shop.backend.entity.Evaluation">
        <id column="eval_id" property="evalId"/>
        <result column="order_id" property="orderId"/>
        <result column="user_id" property="userId"/>
        <result column="seller_id" property="sellerId"/>
        <result column="content" property="content"/>
        <result column="score" property="score"/>
        <result column="status" property="status"/> <!-- 自动匹配EvaluationStatusEnumTypeHandler -->
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 基础字段SQL片段（严格对应数据库表字段） -->
    <sql id="Base_Column_List">
        eval_id, order_id, user_id, seller_id, content, score,
        status, create_time, update_time
    </sql>


    <!-- ==================== 基础CRUD ==================== -->
    <insert id="insert" parameterType="com.community_shop.backend.entity.Evaluation">
        INSERT INTO evaluation (
            order_id, user_id, seller_id, content, score,
            status, create_time, update_time
        ) VALUES (
                     #{orderId}, #{userId}, #{sellerId}, #{content}, #{score},
                     #{status.code,jdbcType=VARCHAR},
                     #{createTime}, #{updateTime}
                 )
    </insert>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM evaluation
        WHERE eval_id = #{evalId}
        AND status = 'VISIBLE' -- 仅查询可见状态的评价
    </select>

    <update id="updateById" parameterType="com.community_shop.backend.entity.Evaluation">
        UPDATE evaluation
        <set>
            <if test="content != null">content = #{content},</if>
            <if test="score != null">score = #{score},</if>
            <if test="status != null">status = #{status.code,jdbcType=VARCHAR},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE eval_id = #{evalId}
        AND user_id = #{userId} -- 仅允许评价者本人修改
    </update>

    <update id="deleteById">
        UPDATE evaluation
        SET status = #{status.code,jdbcType=VARCHAR},
            update_time = NOW()
        WHERE eval_id = #{evalId}
    </update>


    <!-- ==================== 关联查询 ==================== -->
    <select id="selectByOrderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM evaluation
        WHERE order_id = #{orderId}
    </select>

    <select id="selectBySellerId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM evaluation
        WHERE seller_id = #{sellerId}
        AND status = 'VISIBLE' -- 仅查询可见评价
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectByBuyerId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM evaluation
        WHERE user_id = #{userId} -- user_id对应评价者（买家）ID
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>


    <!-- ==================== 统计分析 ==================== -->
    <select id="selectSellerAverageScore" resultType="java.lang.Double">
        SELECT ROUND(AVG(score), 1) FROM evaluation
        WHERE seller_id = #{sellerId}
          AND status = 'VISIBLE'
    </select>

    <select id="countSellerScoreLevel" resultType="int">
        SELECT COUNT(*) FROM evaluation
        WHERE seller_id = #{sellerId}
          AND status = 'VISIBLE'
          AND score BETWEEN #{minScore} AND #{maxScore}
    </select>

    <select id="countByOrderIds" resultType="int">
        SELECT COUNT(*) FROM evaluation
        WHERE order_id IN
        <foreach collection="orderIds" item="orderId" open="(" separator="," close=")">
            #{orderId}
        </foreach>
        AND status = 'VISIBLE'
    </select>

</mapper>