<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community_shop.backend.mapper.UserThirdPartyMapper">

    <!-- 结果集映射：严格匹配user_third_party表字段与UserThirdParty实体 -->
    <resultMap id="BaseResultMap" type="com.community_shop.backend.entity.UserThirdParty">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="openid" property="openid"/>
        <result column="third_type" property="thirdType"/> <!-- 自动匹配ThirdPartyTypeEnumTypeHandler -->
        <result column="access_token" property="accessToken"/>
        <result column="bind_time" property="bindTime"/>
        <result column="remark" property="remark"/>
        <result column="is_valid" property="isValid"/>
    </resultMap>

    <!-- 基础字段SQL片段（严格对应数据库表字段） -->
    <sql id="Base_Column_List">
        id, user_id, openid, third_type, access_token,
        bind_time, remark, is_valid
    </sql>


    <!-- ==================== 关联查询 ==================== -->
    <select id="selectByThirdTypeAndOpenid" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM user_third_party
        WHERE third_type = #{thirdType.code,jdbcType=VARCHAR}
        AND openid = #{openid}
        AND is_valid = 1 -- 仅查询有效绑定记录
    </select>

    <select id="selectValidByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM user_third_party
        WHERE user_id = #{userId}
        AND is_valid = 1
        ORDER BY bind_time DESC
    </select>

    <select id="countByUserIdAndThirdType" resultType="int">
        SELECT COUNT(*) FROM user_third_party
        WHERE user_id = #{userId}
          AND third_type = #{thirdType.code,jdbcType=VARCHAR}
          AND is_valid = 1
    </select>


    <!-- ==================== 状态与凭证更新 ==================== -->
    <update id="updateInvalidById">
        UPDATE user_third_party
        SET is_valid = 0,
            bind_time = NOW() -- 刷新最后操作时间
        WHERE id = #{id}
          AND user_id = #{userId} -- 仅允许用户解绑自己的账号
    </update>

    <update id="updateAccessToken">
        UPDATE user_third_party
        SET access_token = #{newToken},
            bind_time = NOW()
        WHERE third_type = #{thirdType.code,jdbcType=VARCHAR}
          AND openid = #{openid}
          AND is_valid = 1
    </update>

    <update id="batchUpdateInvalidByUserId">
        UPDATE user_third_party
        SET is_valid = 0,
            bind_time = NOW()
        WHERE user_id = #{userId}
    </update>

</mapper>