<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community_shop.backend.mapper.ProductMapper">

    <!-- 结果集映射：严格匹配product表字段与Product实体 -->
    <resultMap id="BaseResultMap" type="com.community_shop.backend.entity.Product">
        <id column="product_id" property="productId"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="category" property="category"/>
        <result column="price" property="price"/>
        <result column="stock" property="stock"/>
        <result column="condition" property="condition"/> <!-- 自动匹配ProductConditionEnumTypeHandler -->
        <result column="seller_id" property="sellerId"/>
        <result column="view_count" property="viewCount"/>
        <result column="status" property="status"/> <!-- 自动匹配ProductStatusEnumTypeHandler -->
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 基础字段SQL片段（严格对应数据库表字段） -->
    <sql id="Base_Column_List">
        product_id, title, description, category, price, stock,
        `condition`, seller_id, view_count, status,
        create_time, update_time
    </sql>


    <!-- ==================== 搜索与筛选 ==================== -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        <where>
            <!-- 默认查询上架状态商品 -->
            <if test="status == null">status = 'ON_SALE'</if>
            <if test="status != null">status = #{status.code,jdbcType=VARCHAR}</if>

            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="minPrice != null">AND price &gt;= #{minPrice}</if>
            <if test="maxPrice != null">AND price &lt;= #{maxPrice}</if>
            <if test="condition != null">
                AND `condition` = #{condition.code,jdbcType=VARCHAR}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectByKeyword" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        WHERE status = 'ON_SALE'
        AND (title LIKE CONCAT('%', #{keyword}, '%')
        OR description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByKeyword" resultType="int">
        SELECT COUNT(*) FROM product
        WHERE status = 'ON_SALE'
          AND (title LIKE CONCAT('%', #{keyword}, '%')
            OR description LIKE CONCAT('%', #{keyword}, '%'))
    </select>

    <select id="countByCondition" resultType="int">
        SELECT COUNT(*) FROM product
        <where>
            <if test="status == null">status = 'ON_SALE'</if>
            <if test="status != null">status = #{status.code,jdbcType=VARCHAR}</if>

            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="minPrice != null">AND price &gt;= #{minPrice}</if>
            <if test="maxPrice != null">AND price &lt;= #{maxPrice}</if>
            <if test="condition != null">
                AND `condition` = #{condition.code,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <!-- 按ProductQueryDTO条件统计商品数量 -->
    <select id="countByQuery" resultType="int">
        SELECT COUNT(*) FROM product
        <where>
            <!-- 状态筛选 -->
            <if test="query.status != null">
                AND status = #{query.status.code,jdbcType=VARCHAR}
            </if>
            <!-- 类别筛选 -->
            <if test="query.category != null and query.category != ''">
                AND category = #{query.category}
            </if>
            <!-- 价格区间筛选 -->
            <if test="query.minPrice != null">
                AND price &gt;= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>
            <!-- 成色筛选 -->
            <if test="query.condition != null">
                AND `condition` = #{query.condition.code,jdbcType=VARCHAR}
            </if>
            <!-- 卖家ID筛选 -->
            <if test="query.sellerId != null">
                AND seller_id = #{query.sellerId}
            </if>
            <!-- 关键词搜索（标题/描述） -->
            <if test="query.keyword != null and query.keyword != ''">
                AND (title LIKE CONCAT('%', #{query.keyword}, '%')
                OR description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
    </select>


    <!-- 按ProductQueryDTO条件分页查询商品 -->
    <select id="selectByQuery" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        <where>
            <!-- 状态筛选 -->
            <if test="query.status != null">
                AND status = #{query.status.code,jdbcType=VARCHAR}
            </if>
            <!-- 类别筛选 -->
            <if test="query.category != null and query.category != ''">
                AND category = #{query.category}
            </if>
            <!-- 价格区间筛选 -->
            <if test="query.minPrice != null">
                AND price &gt;= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>
            <!-- 成色筛选 -->
            <if test="query.condition != null">
                AND `condition` = #{query.condition.code,jdbcType=VARCHAR}
            </if>
            <!-- 卖家ID筛选 -->
            <if test="query.sellerId != null">
                AND seller_id = #{query.sellerId}
            </if>
            <!-- 关键词搜索（标题/描述） -->
            <if test="query.keyword != null and query.keyword != ''">
                AND (title LIKE CONCAT('%', #{query.keyword}, '%')
                OR description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
        <!-- 排序：默认按创建时间倒序 -->
        <if test="query.orderBy != null and query.orderBy != ''">
            ORDER BY ${query.orderBy} ${query.sortDir}
        </if>
        <if test="query.orderBy == null or query.orderBy == ''">
            ORDER BY create_time DESC
        </if>
        <!-- 分页 -->
        LIMIT #{query.offset}, #{query.limit}
    </select>

    <!-- 按卖家查询条件统计商品数量 -->
    <select id="countBySellerQuery" resultType="int">
        SELECT COUNT(*) FROM product
        <where>
            <!-- 卖家ID固定筛选（当前登录卖家只能查看自己的商品） -->
            <if test="query.sellerId != null">
                AND seller_id = #{query.sellerId}
            </if>

            <!-- 商品状态筛选（卖家视角的状态筛选） -->
            <if test="query.status != null">
                AND status = #{query.status.code,jdbcType=VARCHAR}
            </if>

            <!-- 商品标题关键词搜索 -->
            <if test="query.titleKeyword != null and query.titleKeyword != ''">
                AND title LIKE CONCAT('%', #{query.titleKeyword}, '%')
            </if>

            <!-- 上架时间范围筛选 -->
            <if test="query.startTime != null">
                AND create_time &gt;= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND create_time &lt;= #{query.endTime}
            </if>

            <!-- 价格区间筛选 -->
            <if test="query.minPrice != null">
                AND price &gt;= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>

            <!-- 销量筛选 -->
            <if test="query.minSales != null">
                AND sales &gt;= #{query.minSales}
            </if>
            <if test="query.maxSales != null">
                AND sales &lt;= #{query.maxSales}
            </if>
        </where>
    </select>

    <!-- 按卖家查询条件分页查询商品 -->
    <select id="selectBySellerQuery" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        <where>
            <!-- 卖家ID固定筛选（当前登录卖家只能查看自己的商品） -->
            <if test="query.sellerId != null">
                AND seller_id = #{query.sellerId}
            </if>

            <!-- 商品状态筛选（卖家视角的状态筛选） -->
            <if test="query.status != null">
                AND status = #{query.status.code,jdbcType=VARCHAR}
            </if>

            <!-- 商品标题关键词搜索 -->
            <if test="query.titleKeyword != null and query.titleKeyword != ''">
                AND title LIKE CONCAT('%', #{query.titleKeyword}, '%')
            </if>

            <!-- 上架时间范围筛选 -->
            <if test="query.startTime != null">
                AND create_time &gt;= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND create_time &lt;= #{query.endTime}
            </if>

            <!-- 价格区间筛选 -->
            <if test="query.minPrice != null">
                AND price &gt;= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>

            <!-- 销量筛选 -->
            <if test="query.minSales != null">
                AND sales &gt;= #{query.minSales}
            </if>
            <if test="query.maxSales != null">
                AND sales &lt;= #{query.maxSales}
            </if>
        </where>

        <!-- 排序：支持卖家常用的排序方式 -->
        <if test="query.sortField != null and query.sortDir != null">
            ORDER BY ${query.sortField} ${query.sortDir}
        </if>
        <if test="query.sortField == null">
            <!-- 默认按更新时间倒序 -->
            ORDER BY update_time DESC
        </if>

        <!-- 分页参数 -->
        <if test="query.pageNum != null and query.pageSize != null">
            LIMIT #{query.offset}, #{query.pageSize}
        </if>
    </select>

    <!-- ==================== 库存与卖家查询 ==================== -->
    <update id="updateStock">
        UPDATE product
        SET stock = #{stock},
            update_time = NOW()
        WHERE product_id = #{productId}
    </update>

    <update id="updateViewCount">
        UPDATE product
        SET view_count = view_count + 1,
            update_time = NOW()
        WHERE product_id = #{productId}
    </update>

    <select id="selectBySellerId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        WHERE seller_id = #{sellerId}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectBySellerIdAndStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM product
        WHERE seller_id = #{sellerId}
        AND status = #{status.code,jdbcType=VARCHAR}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>


</mapper>